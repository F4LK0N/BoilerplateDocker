#!/bin/sh

mode=$1;
user=$2;
group=$3;
path=$4;
truncate='N';
if [[ "$1" == '' ]]; then setup-fs-set-error "'MODE' required!"; return; fi;
if [[ "$2" == '' ]]; then setup-fs-set-error "'USER' required!"; return; fi;
if [[ "$3" == '' ]]; then setup-fs-set-error "'GROUP' required!"; return; fi;
if [[ "$4" == '' ]]; then setup-fs-set-error "'PATH' required!"; return; fi;
if [[ "$5" != '' ]]; then truncate='Y'; return; fi;
export setupFsPath="${path}";

### PATH TYPE (DIR|FILE) ###
pathType='F';
if [[ "/" == "${path: -1}" ]]; then
    pathType='D';
fi;
echo -n "${pathType}[";

### CREATE ###
if [[ "D" == "${pathType}" ]]; then
    # DIR #
    if [[ -d "${path}" ]]; then
        echo -n "=";
    else
        export setupFsError=$( mkdir -p --mode=777 "${path}" 2>&1 );
        if [[ ! -d "${path}" ]]; then echo -n "!"; else echo -n "+"; fi;
    fi;
else
    # FILE #
    if [[ -f "${path}" ]]; then
        echo -n "=";
    else
        export setupFsError=$( touch "${path}" 2>&1 );
        if [[ ! -f "${path}" ]]; then echo -n "!"; else echo -n "+"; fi;
    fi;
fi;



### MODE ###
if [[ "${setupFsError}" != "" ]]; then
    echo -n "-";
elif [[ "${mode}" == "$( stat -c %a ${path} )" ]]; then
    echo -n "=";
else
    export setupFsError=$( chmod ${mode} "${path}" 2>&1 );
    if [[ "${mode}" != "$( stat -c %a ${path} )" ]]; then echo -n "!"; else echo -n "+"; fi;
fi;



### USER ###
if [[ "${setupFsError}" != "" ]]; then
    echo -n "-";
elif [[ "${user}" == "$( stat -c %U ${path} )" ]]; then
    echo -n "=";
else
    export setupFsError=$( chown "${user}" "${path}" 2>&1 );
    if [[ "${user}" != "$( stat -c %U ${path} )" ]]; then echo -n "!"; else echo -n "+"; fi;
fi;



### GROUP ###
if [[ "${setupFsError}" != "" ]]; then
    echo -n "-";
elif [[ "${group}" == "$( stat -c %G ${path} )" ]]; then
    echo -n "=";
else
    export setupFsError=$( chown :${group} "${path}" 2>&1 );
    if [[ "${group}" != "$( stat -c %G ${path} )" ]]; then echo -n "!"; else echo -n "+"; fi;
fi;



### TRUNCATE ###
if [[ "${setupFsError}" != "" ]]; then
    echo -n "-";
elif [[ "${truncate}" == "N" ]]; then
    echo -n "=";
else
    truncate -s 0 ${path};
    echo -n "+";
fi



### PATH ###
padding=" ______________________________________________________________________";
printf "] %s %s" "$path" "${padding:${#path}}";



### RESULT ###
if [[ "${setupFsError}" != "" ]]; then
    echo "[ERROR] ${setupFsError}";
else
    echo "[OK]";
fi;
