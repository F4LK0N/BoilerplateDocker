#!/bin/sh

mode=$1;
user=$2;
group=$3;
path=$4;
truncate='N';
if [[ "$1" == '' ]]; then setup-fs-set-error "'MODE' required!"; return; fi;
if [[ "$2" == '' ]]; then setup-fs-set-error "'USER' required!"; return; fi;
if [[ "$3" == '' ]]; then setup-fs-set-error "'GROUP' required!"; return; fi;
if [[ "$4" == '' ]]; then setup-fs-set-error "'PATH' required!"; return; fi;
if [[ "$5" != '' ]]; then truncate='Y'; return; fi;
export setupFsPath="${path}";

### PATH TYPE (DIR|FILE) ###
pathType='F';
if [[ "/" == "${path: -1}" ]]; then
    pathType='D';
fi;
echo -n "[${pathType}] ";

### CREATE ###
if [[ "D" == "${pathType}" ]]; then
    # DIR #
    if [[ -d "${path}" ]]; then
        echo -n "=";
    else
        export setupFsError=$( mkdir -p --mode=777 "${path}" 2>&1 );
        if [[ ! -d "${path}" ]]; then setup-fs-set-error "!---"; return; fi;
        echo -n "+";
    fi
else
    # FILE #
    if [[ -f "${path}" ]]; then
        echo -n "=";
    else
        export setupFsError=$( touch "${path}" 2>&1 );
        if [[ ! -f "${path}" ]]; then setup-fs-set-error "!---"; return; fi;
        echo -n "+";
    fi
fi

### MODE ###
if [[ "${mode}" == "$( stat -c %a ${path} )" ]]; then
    echo -n "=";
else
    chmod ${mode} "${path}" > /dev/null 2>&1
    if [[ "${mode}" != "$( stat -c %a ${path} )" ]]; then
        if [[ ! -f "${path}" ]]; then setup-fs-set-error "!-- ${path}"; return; fi;
    fi
    echo -n "+";
fi



### USER ###
if [[ "${user}" == "$( stat -c %U ${path} )" ]]; then
    echo -n "=";
else
    chown "${user}" "${path}" > /dev/null 2>&1
    if [[ "${user}" != "$( stat -c %U ${path} )" ]]; then
        if [[ ! -f "${path}" ]]; then setup-fs-set-error "!- ${path}"; return; fi;
    fi
    echo -n "+";
fi



### GROUP ###
if [[ "${group}" == "$( stat -c %G ${path} )" ]]; then
    echo -n "=";
else
    chown :${group} "${path}" > /dev/null 2>&1
    if [[ "${group}" != "$( stat -c %G ${path} )" ]]; then
        if [[ ! -f "${path}" ]]; then setup-fs-set-error "! ${path}"; return; fi;
    fi
    echo -n "+";
fi



### TRUNCATE ###
if [[ "${truncate}" == "N" ]]; then
    echo -n "=";
else
    truncate -s 0 ${path};
    echo -n "+";
fi



echo " ${path}";
